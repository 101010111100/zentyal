<%args>
    @domains
    @inaddrs
    @intnets
    $confDir
    $dynamicConfDir
</%args>
<%init>
use EBox::Config;

my $generateReverseZones = EBox::Config::boolean('generate_reverse_zones');
</%init>
// Generated by Zentyal

acl "trusted" {
% foreach my $intnet (@intnets) {
    <% $intnet %>;
% }
    localhost;
    localnets;
};

% foreach my $dom (@domains) {
%   if ($dom->{samba}) {
dlz "AD DNS Zone - <% $dom->{name} %>" {
    database "dlopen /opt/samba4/lib/bind9/dlz_bind9.so";
};
%       next;
%   }
zone "<% $dom->{name} %>." IN {
    type master;
%       if ($dom->{dynamic}) {
    file "<% $dynamicConfDir %>/db.<% $dom->{'name'} %>";
%       } else {
    file "<% $confDir %>/db.<% $dom->{'name'} %>";
%       }
%       if ($dom->{dynamic}) {
    update-policy {
        // The only allowed dynamic updates are A records
        grant <% $dom->{'name'} %>. subdomain <% $dom->{'name'} %>. A TXT;
        // Grant from localhost
        grant local-ddns zonesub any;
    };
%       }
};
% }

% if ($generateReverseZones) {
%   foreach my $inaddr (@inaddrs) {
zone "<% $inaddr->{'ip'} %>.in-addr.arpa" {
    type master;
    file "<% $inaddr->{'file'} %>";
    update-policy {
        // The only allowed dynamic updates are PTR records
%       foreach my $keyName (@{$inaddr->{'keyNames'}}) {
        grant <% $keyName %>. subdomain <% $inaddr->{'ip'} %>.in-addr.arpa. PTR TXT;
%       }
        // Grant from localhost
        grant local-ddns zonesub any;
    };
};
%   }
% }

include "/etc/bind/zones.rfc1918";
